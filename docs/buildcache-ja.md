# Build Cache Cluster 利用時のデータの保存方法について
- クラスタ内のデータはタスク単位でシャーディングされています。
- 各タスクには一意の識別子が割り当てられ、それが特定のシャードにマッピングされます。
- データは概ねバランスされますが、必ずしも均等になるわけではありません。たとえば、5ノードで10タスクの場合、常に各ノードに2タスクずつ割り当てられるとは限りません。
- 各ビルドキャッシュノードはデータの1シャードを保持します。
- クラスタのノード構成を変更すると、データがどうシャーディングされるかも変更されます。

# Build Cache のログレベル（Off, Automatic, On）に関して（Agent Settings で設定可能）
## Automatic モード
- キャッシュミスのうち約3%分のミス情報のみを収集します。
- レポートは、ビルド結果の最後に「ヒットよりミスが多い」場合に生成されます。
- この場合のパフォーマンスへの影響は無視できると考えています。
  - （ヒット率が低いと）タスク実行数が多いためにビルド時間が相対的に長くなっており、かつ（上記で説明したように）レポートに表示されるタスク数も少ないためです。
- 例として、コンパイラバージョンを変更した場合、1回目のビルドはすべてミスとなりキャッシュに登録され、次のビルドで通常のヒット率に戻ります。
  - もし「なぜ前回のビルドはヒットが0だったのか」を調査した場合、このレポートにはツールバージョン起因の複数のミスが表示され、原因を理解するにはそれで十分なことが多いです。
## その他
- レポートを常に「On」にしておくのは、おそらく大きな時間の無駄になります。パフォーマンスが大幅に低下します。
- コマンドラインからビルドキャッシュの詳細レベルを設定することはできません。
  - On のレポートの主な用途は、50%以上あるヒット率をさらに改善したい場合です。たとえば、ヒット率が70%で、80%まで引き上げられると考えているケースなどです。その結果としてはコードをより深く調査する必要があることが多く、CIで一般的に使われるコマンドライン操作にはあまり適していません。
